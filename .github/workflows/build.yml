name: Build and Push Docker Image

on:
  push:
    branches: [main]
    tags: ['v*']

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  INFRA_REPO: ${{ github.repository_owner }}/infra-live
  INFRA_BRANCH: main
  INFRA_APP_PATH: apps/${{ github.event.repository.name }}

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      short_sha: ${{ steps.vars.outputs.short_sha }}
      image: ${{ steps.vars.outputs.image }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Compute vars
        id: vars
        run: |
          echo "short_sha=$(git rev-parse --short=7 HEAD)" >> $GITHUB_OUTPUT
          echo "image=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}" >> $GITHUB_OUTPUT
      
      - uses: docker/setup-buildx-action@v3
      
      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,format=short,prefix=sha-
      
      - uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  update-infra:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: write
    
    steps:
      - name: Checkout infra-live
        uses: actions/checkout@v4
        with:
          repository: ${{ env.INFRA_REPO }}
          ref: ${{ env.INFRA_BRANCH }}
          token: ${{ secrets.GITHUB_TOKEN }}
          path: infra-live
      
      - name: Install kustomize
        run: |
          curl -sSLo kustomize.tar.gz https://github.com/kubernetes-sigs/kustomize/releases/latest/download/kustomize_linux_amd64.tar.gz
          tar -xzf kustomize.tar.gz
          sudo mv kustomize /usr/local/bin/kustomize
          kustomize version
      
      - name: Bump image tag
        working-directory: infra-live/${{ env.INFRA_APP_PATH }}
        run: |
          set -euo pipefail
          TAG="sha-${{ needs.build.outputs.short_sha }}"
          IMG="${{ needs.build.outputs.image }}"
          
          echo "Updating ${IMG} to tag: ${TAG}"
          kustomize edit set image "${IMG}=${IMG}:${TAG}"
          
          echo "Updated kustomization.yaml:"
          cat kustomization.yaml
      
      - name: Commit & push
        working-directory: infra-live
        run: |
          set -euo pipefail
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add .
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore(${{ github.event.repository.name }}): deploy sha-${{ needs.build.outputs.short_sha }}

          Triggered by: ${{ github.repository }}@${{ github.sha }}
          Message: ${{ github.event.head_commit.message }}"
            
            git push
            echo "âœ… Successfully updated infra-live"
          fi
